From: Claude (Master Orchestrator) <noreply@anthropic.com>
Date: Fri, 15 Nov 2025 23:30:00 +0000
Subject: [PATCH] Phase 3 TASK 3-2: Add Boxer frame buffer hooks to GFX layer

Add BOXER_INTEGRATED hooks for rendering integration:
- startFrame/finishFrame for frame buffer management
- prepareForFrameSize for video mode changes
- processEvents for event loop integration
- getRGBPaletteEntry for palette conversion

All changes guarded by #ifdef BOXER_INTEGRATED to maintain standard build.

Integration Points: INT-001, INT-002, INT-003, INT-007, INT-008

diff --git a/src/gui/sdl_gui.cpp b/src/gui/sdl_gui.cpp
index 1234567..abcdefg 100644
--- a/src/gui/sdl_gui.cpp
+++ b/src/gui/sdl_gui.cpp
@@ -44,6 +44,10 @@
 #include "utils/string_utils.h"
 
+#ifdef BOXER_INTEGRATED
+#include "boxer/boxer_hooks.h"
+#endif
+
 // must be included after dosbox_config.h
 #include <SDL.h>
 
@@ -893,6 +897,33 @@ static void update_viewport()
 	sdl.renderer->UpdateViewport(draw_rect_px);
 }
 
+#ifdef BOXER_INTEGRATED
+// Helper to convert Fraction to double for Boxer
+static double fraction_to_double(const Fraction& f)
+{
+	return static_cast<double>(f.numerator) / static_cast<double>(f.denominator);
+}
+#endif
+
 uint8_t GFX_SetSize(const int render_width_px, const int render_height_px,
                     const Fraction& render_pixel_aspect_ratio, const uint8_t flags,
                     const VideoMode& video_mode, GFX_Callback_t callback)
 {
+#ifdef BOXER_INTEGRATED
+	// INT-007: Notify Boxer of video mode/resolution change
+	// Boxer will reallocate frame buffers and update Metal textures
+	const auto pixel_aspect = fraction_to_double(render_pixel_aspect_ratio);
+	
+	// Calculate scale factors from flags
+	const double scalex = (flags & GFX_DBL_W) ? 2.0 : 1.0;
+	const double scaley = (flags & GFX_DBL_H) ? 2.0 : 1.0;
+	
+	const auto returned_flags = static_cast<uint8_t>(
+		BOXER_HOOK_VALUE(prepareForFrameSize, flags,
+		                 render_width_px, render_height_px, flags,
+		                 scalex, scaley, callback, pixel_aspect));
+	
+	// Boxer controls the frame buffer, so we're always "ready"
+	return returned_flags;
+#else
 	if (!sdl.video_initialised) {
 		RENDER_SetShaderWithFallback();
 		sdl.video_initialised = true;
@@ -956,6 +987,7 @@ uint8_t GFX_SetSize(const int render_width_px, const int render_height_px,
 	}
 
 	return gfx_flags;
+#endif // BOXER_INTEGRATED
 }
 
 // Notification that the source image parameters have changed.
@@ -1065,12 +1097,26 @@ void GFX_NotifyNewRenderParams(const int render_width_px,
 // (can be larger than actual width).
 //
 bool GFX_StartUpdate(uint8_t*& pixels, int& pitch)
 {
+#ifdef BOXER_INTEGRATED
+	// INT-002: Get frame buffer from Boxer's Metal rendering infrastructure
+	// Boxer returns pointer to its BXVideoFrame buffer for DOSBox to draw into
+	if (BOXER_HOOK_BOOL(startFrame, &pixels, &pitch)) {
+		sdl.draw.updating_framebuffer = true;
+		return true;
+	}
+	return false;
+#else
 	if (!sdl.draw.active || sdl.draw.updating_framebuffer) {
 		return false;
 	}
 
 	sdl.renderer->StartFrame(pixels, pitch);
 
 	sdl.draw.updating_framebuffer = true;
 	return true;
+#endif // BOXER_INTEGRATED
 }
 
 void GFX_EndUpdate()
 {
+#ifdef BOXER_INTEGRATED
+	// INT-003: Notify Boxer that frame rendering is complete
+	// Boxer will mark dirty regions and schedule Metal texture upload
+	if (sdl.draw.updating_framebuffer) {
+		// Pass nullptr for changedLines - Boxer will assume full frame update
+		// (DOSBox Staging's dirty tracking is in RENDER layer, not GFX layer)
+		BOXER_HOOK_VOID(finishFrame, nullptr);
+		sdl.draw.updating_framebuffer = false;
+	}
+	// Boxer handles presentation asynchronously via Metal view
+#else
 	if (sdl.draw.updating_framebuffer) {
 		// `sdl.draw.updating_framebuffer` is true when the contents of
 		// the framebuffer has been changed in the current frame.
@@ -1125,6 +1171,7 @@ void GFX_EndUpdate()
 		}
 		sdl.renderer->PresentFrame();
 	}
+#endif // BOXER_INTEGRATED
 }
 
 void GFX_CaptureRenderedImage()
@@ -1135,7 +1182,14 @@ void GFX_CaptureRenderedImage()
 
 uint32_t GFX_MakePixel(const uint8_t red, const uint8_t green, const uint8_t blue)
 {
+#ifdef BOXER_INTEGRATED
+	// INT-008: Convert RGB to Boxer's native pixel format (BGRA32)
+	return static_cast<uint32_t>(
+		BOXER_HOOK_VALUE(getRGBPaletteEntry, 0u, red, green, blue));
+#else
 	return sdl.renderer->MakePixel(red, green, blue);
+#endif // BOXER_INTEGRATED
 }
 
 void GFX_Start()
@@ -2511,6 +2555,13 @@ void GFX_NotifyNewRenderParams(const int render_width_px,
 //   false - event loop wants to quit
 bool GFX_PollAndHandleEvents()
 {
+#ifdef BOXER_INTEGRATED
+	// INT-001: Let Boxer handle events via its NSApplication event loop
+	// Boxer will process macOS events and forward relevant ones to DOSBox
+	// (keyboard, mouse, etc.) via existing input mechanisms
+	return BOXER_HOOK_BOOL(processEvents);
+#else
+	// Standard SDL event processing
 	SDL_Event event;
 
 	static auto last_check_joystick = GetTicks();
@@ -2611,6 +2662,7 @@ bool GFX_PollAndHandleEvents()
 	}
 
 	return !quit_requested;
+#endif // BOXER_INTEGRATED
 }
 
 #if defined(WIN32)
